{% extends "base.html" %} {% block contenido %}
<div class="max-auto bg-white p-6 rounded shadow">
  <h1 class="mb-2-red">
    <span class="text-2xl font-semibold mb-4 text-gray-700"
      >Crear Consentimientos Informados</span
    >
  </h1>
  <br />
  <h2 class="mb-1">
    <span class="text-md font-medium mb-4 text-gray-600"
      >Gestiona los consentimientos informados de los pacientes</span
    >
  </h2>
  <div
    class="p-4 text-sm text-[#1D5E65] rounded bg-[#B3E2E1] w-full"
    role="alert"
  >
    <span class="font-bold">
      <i class="fa-solid fa-shield"></i> Seguridad de Firmas <br
    /></span>
    Por protecci√≥n de la privacidad del paciente, las firmas digitales no se
    almacenan en el sistema. Solo se incluyen en el PDF generado y se eliminan
    autom√°ticamente despu√©s de la generaci√≥n del documento
  </div>
  <div class="p-6">
    <h1 class="text-2xl font-semibold mb-4 text-gray-700">Buscar Paciente</h1>

    <!-- Buscador -->
    <div class="relative max-w-lg">
      <input
        id="buscarInput"
        type="text"
        placeholder="Escriba nombre o c√©dula del paciente..."
        class="border rounded-lg w-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <a
        href="/formulario"
        class="bg-neutral-primary-soft block border border-default rounded-base shadow-xs transition hover:bg-gray-200"
      ></a>
      <!-- Resultados din√°micos -->
      <div
        id="resultados"
        class="absolute bg-white border rounded-lg mt-1 w-full shadow hidden z-10"
      ></div>
    </div>

    <!-- Bot√≥n de prueba manual -->
    <div class="mt-6">
      <a
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        href="/pacientes/agregar"
        >agregar pacientes</a
      >
      <a
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        href="/consentimientos/nuevo"
        >nuevo</a
      >
      <a
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        href="/plantillas_consentimiento/nuevo"
        >nueva plantilla de consentimientos</a
      >
      <!-- <button onclick="abrirModalPaciente(1, 'Juan P√©rez', 'CC', '123456789', 'Bogot√°')"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      üîç Probar Modales
    </button> -->
      <!-- AGRUPADOR PACIENTE + FIRMA -->
      <div
        id="bloquePaciente"
        class="hidden mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"
      >
        <!-- CARD PACIENTE -->
        <div class="bg-white border rounded-lg p-4 shadow">
          <h3 class="text-lg font-semibold mb-2">Paciente seleccionado</h3>

          <p><strong>Nombre:</strong> <span id="p_nombre"></span></p>
          <p><strong>C√©dula:</strong> <span id="p_cedula"></span></p>
          <p><strong>Ciudad:</strong> <span id="p_ciudad"></span></p>

          <input type="hidden" name="paciente_id" id="paciente_id" />
        </div>

        <!-- FIRMA -->
        <div class="bg-white border rounded-lg p-4 shadow">
          <h3 class="text-lg font-semibold mb-2">Firma del paciente</h3>

          <canvas id="firmaCanvas" class="border w-full h-40"></canvas>

          <div class="flex gap-2 mt-3">
            <button
              type="button"
              onclick="limpiarFirma()"
              class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
            >
              Limpiar
            </button>

            <label
              class="px-3 py-1 bg-blue-600 text-white rounded cursor-pointer"
            >
              Subir firma
              <input type="file" id="firmaUpload" accept="image/*" hidden />
            </label>
          </div>

          <input type="hidden" name="firma_paciente" id="firma_paciente" />
        </div>
      </div>
    </div>

    <!-- ===================== MODAL 1 ‚Äî DATOS DEL PACIENTE ===================== -->
    <div
      id="modalPaciente"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-96 p-6 shadow-lg relative">
        <h2 class="text-xl font-semibold mb-4">Datos del Paciente</h2>

        <div class="space-y-2">
          <p><strong>Nombre:</strong> <span id="pacienteNombre"></span></p>
          <p>
            <strong>Tipo de documento:</strong> <span id="pacienteTipo"></span>
          </p>
          <p>
            <strong>Documento:</strong> <span id="pacienteDocumento"></span>
          </p>
          <p>
            <strong>Ciudad de expedici√≥n:</strong>
            <span id="pacienteCiudad"></span>
          </p>
        </div>

        <div class="flex justify-end mt-5 gap-3">
          <button
            onclick="cerrarModal('modalPaciente')"
            class="px-3 py-1 border rounded text-gray-600 hover:bg-gray-100"
          >
            Cerrar
          </button>
          <button
            onclick="abrirModalFirma()"
            class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
          >
            Firmar
          </button>
        </div>
      </div>
    </div>
    <!-- CONFIGURACI√ìN DEL CONSENTIMIENTO -->
    <div
      id="configConsentimiento"
      class="mt-8 bg-white border rounded-lg p-6 shadow"
    >
      <h3 class="text-xl font-semibold mb-4">
        Configuraci√≥n del consentimiento
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- PAQUETE -->
        <div>
          <label class="block text-sm font-medium mb-1">Paquete</label>
          <select id="paquete_id" class="w-full border rounded p-2">
            <option value="">Seleccione un paquete</option>
            {% for p in paquetes %}
            <option value="{{ p.id }}">{{ p.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- FECHA -->
        <div>
          <label class="block text-sm font-medium mb-1">Fecha</label>
          <input
            type="date"
            id="fecha_consentimiento"
            class="w-full border rounded p-2"
            value="{{ today }}"
          />
        </div>

        <!-- DOCTOR -->
        <div>
          <label class="block text-sm font-medium mb-1">Doctor</label>
          <select id="doctor_id" class="w-full border rounded p-2">
            <option value="">Seleccione</option>
            {% for d in doctores %}
            <option value="{{ d.id }}">{{ d.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ENFERMERO -->
        <div>
          <label class="block text-sm font-medium mb-1">Enfermero</label>
          <select id="enfermero_id" class="w-full border rounded p-2">
            <option value="">Seleccione</option>
            {% for e in enfermeros %}
            <option value="{{ e.id }}">{{ e.nombre }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- LISTA DE CONSENTIMIENTOS -->
      <div class="mt-6">
        <h4 class="font-semibold mb-2">Consentimientos disponibles</h4>
        <div
          id="listaConsentimientos"
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
        >
          <p class="text-gray-500">Seleccione un paquete‚Ä¶</p>
        </div>
      </div>
    </div>

    <!-- ===================== MODAL 2 ‚Äî FIRMA ===================== -->
    <div
      id="modalFirma"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-[500px] p-6 shadow-lg relative">
        <h2 class="text-xl font-semibold mb-4">Firma del Paciente</h2>

        <p class="text-gray-600 text-sm mb-3">
          Use una tableta o el mouse para firmar:
        </p>

        <canvas
          id="canvasFirma"
          class="border w-full h-48 rounded mb-3"
        ></canvas>

        <div class="flex justify-between items-center">
          <input
            type="file"
            id="firmaArchivo"
            accept="image/*"
            class="text-sm"
          />
          <button
            onclick="limpiarFirma()"
            class="text-sm text-gray-600 hover:underline"
          >
            Limpiar
          </button>
        </div>

        <div class="flex justify-end mt-5 gap-3">
          <button
            onclick="cerrarModal('modalFirma')"
            class="px-3 py-1 border rounded text-gray-600 hover:bg-gray-100"
          >
            Cancelar
          </button>
          <button
            onclick="guardarFirma()"
            class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
          >
            Guardar Firma
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- ===================== SCRIPTS ===================== ## -->
  <script>
    const paqueteSelect = document.getElementById("paqueteSelect");
    const lista = document.getElementById("listaConsentimientos");

    console.log("JS cargado", paqueteSelect);

    paqueteSelect.addEventListener("change", async function () {
      const paqueteId = this.value;
      console.log("Paquete cambiado:", this.value);

      lista.innerHTML =
        "<p class='text-gray-500'>Cargando consentimientos‚Ä¶</p>";

      if (!paqueteId) {
        lista.innerHTML = "<p class='text-gray-500'>Seleccione un paquete‚Ä¶</p>";
        return;
      }

      const res = await fetch(`/api/plantillas_por_paquete/${paqueteId}`);
      const data = await res.json();

      if (data.length === 0) {
        lista.innerHTML =
          "<p class='text-red-500'>Este paquete no tiene consentimientos</p>";
        return;
      }

      lista.innerHTML = "";

      data.forEach((p) => {
        lista.innerHTML += `
      <div class="border rounded p-4 shadow bg-gray-50">
        <p class="font-medium mb-2">${p.nombre}</p>

        <button
          onclick="generarConsentimiento(${p.id})"
          class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
          Generar / Descargar
        </button>
      </div>
    `;
      });
    });

    function generarConsentimiento(plantillaId) {
      alert("Aqu√≠ generaremos el consentimiento ID: " + plantillaId);
      // En el siguiente paso lo conectamos con /generar
    }
  </script>
</div>
{% endblock %}
